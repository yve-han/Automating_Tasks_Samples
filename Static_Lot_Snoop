import os
import pandas as pd
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
import logging
import PyUber

# Configure logging
logging.basicConfig(level=logging.INFO)

# Source
source = 'Company Server'

# SQL Query
prime_query = """
WITH CombinedData AS (
    SELECT 
        LOT,
        OPERATION,
        COMMENT_TIMESTAMP AS DATE_COLUMN,
        COMMENT_TYPE AS TYPE,
        COMMENT_TEXT AS TEXT
    FROM T6
    UNION ALL
    SELECT
        LOT,
        OPERATION,
        TXN_DATE AS DATE_COLUMN,
        "TRANSACTION" AS TYPE,
        COMMENTS AS TEXT
    FROM T5
),
RankedData AS (
    SELECT
        LOT,
        OPERATION,
        DATE_COLUMN,
        TYPE,
        TEXT,
        ROW_NUMBER() OVER (PARTITION BY LOT, OPERATION ORDER BY DATE_COLUMN DESC) AS RN
    FROM CombinedData
),
LATESTT5 AS (
    SELECT
        LOT,
        OPERATION,
        DATE_COLUMN AS TXN_DATE,
        TYPE AS "TRANSACTION",
        TEXT AS COMMENTS,
        RN
    FROM RankedData
    WHERE RN = 1
)

SELECT DISTINCT 
  T0.LOT,
  T0.OPERATION || ' ' || T0.OPER_SHORT_DESC as OPERATION,
  T0.PRODUCT,
  T0.DOTPROCESS,
  T0.LOT_TYPE,
  T0.LOT_PRIORITY as HB,
  T5.COMMENTS,
  T0.LOT_STATE,
  T0.ONHOLD,
  ROUND((SYSDATE - T0.PREV_OPER_OUT_DATE)*24,2) as HAO,
  T0.HOLD_CATEGORY,
  SUBSTR(T0.HOLD_NAME, 5) as HOLD_NAME,
  T0.ATSTORES,
  T0.STORES_CATEGORY,
  WH.FIRST_NAME AS HO_NAME,
  WH.CORPORATE_EMAIL AS HO_EMAIL,
  WL.CORPORATE_EMAIL AS LO_EMAIL,
  WL.FIRST_NAME AS LO_NAME
FROM T0
JOIN T3 ON T0.LOT = T3.LOT
LEFT JOIN WL ON T0.LOT_OWNER = WL.IDSID
LEFT JOIN WH ON SUBSTR(T0.HOLD_NAME, 5) = WH.IDSID
LEFT JOIN (
      SELECT 
         LOT,
         OPERATION,
         TXN_DATE,
         "TRANSACTION",
         COMMENTS
      FROM LATESTT5
      WHERE RN = 1
      ) T5 ON T0.LOT = T5.LOT and T0.OPERATION = T5.OPERATION
WHERE T0.TERMINATED = 'N' 
      and T0.ONHOLD = 'Y'
      and T0.PRODUCT not like 'NOPROD%'
      and T0.LOT_TYPE not like 'MW'
"""

# Function to create HTML table
def create_html_table(dataframe):
    html = '<table border="1">'
    html += '<tr><th>Lot</th><th>Operation</th><th>Hot Box</th><th>HAO</th><th>Dot Process</th><th>Product</th><th>On Hold</th><th>Hold Category</th><th>Hold Name</th><th>Comments</th><th>At Stores</th><th>Lot State</th></tr>'
    for index, row in dataframe.iterrows():
        html += f'<tr><td>{row["LOT"]}</td><td>{row["OPERATION"]}</td><td>{row["HB"]}</td><td>{row["HAO"]}</td><td>{row["DOTPROCESS"]}</td><td>{row["PRODUCT"]}</td><td>{row["ONHOLD"]}</td><td>{row["HOLD_CATEGORY"]}</td><td>{row["HOLD_NAME"]}</td><td>{row["COMMENTS"]}</td><td>{row["ATSTORES"]}</td><td>{row["LOT_STATE"]}</td></tr>'
    html += '</table>'
    return html

# Function to send email
def send_email(to_email, cc_email, subject, html_content):
    email_user = 'NMDMOPROD@intel.com'

    msg = MIMEMultipart()
    msg['From'] = email_user
    msg['To'] = to_email
    msg['Cc'] = cc_email
    msg['Subject'] = subject

    msg.attach(MIMEText(html_content, 'html'))

    try:
        # Connect to the SMTP server without specifying a port
        with smtplib.SMTP('smtp.intel.com') as smtp_server:
            smtp_server.sendmail(email_user, [to_email, cc_email], msg.as_string())
            logging.info(f"Email sent to {to_email} with CC to {cc_email} and subject '{subject}'.")
    except Exception as e:
        logging.error(f"Failed to send email to {to_email} with CC to {cc_email}: {e}")

# Query Process
def send_emails():
    try:
        conn = PyUber.connect(datasource=source, TimeOutInSeconds=6000)
        logging.info("Database connection established.")
        
        query_df = pd.read_sql_query(prime_query, conn)
        logging.info("Query executed successfully.")
        
        conn.close()
        logging.info("Database connection closed.")
    
        # Print DataFrame columns for debugging
        print("DataFrame columns:", query_df.columns)

        email_user = 'NMDMOPROD@intel.com'
        

        # Group by HOLD_NAME_EMAIL for ONHOLD lots
        onhold_grouped = query_df[query_df['ONHOLD'] == 'Y'].groupby('HO_EMAIL')

        for email, group in onhold_grouped:
            first_name = group['HO_NAME'].iloc[0]
            subject = "[P5051 Help Needed] Hold Lot Disposition"
            
            # Override the recipient email with the test email address for testing
            to_email = email
            #cc_email = 'f11x.roc.line.co@intel.com','nm.captains@intel.com' # CC the lot owner email group['LOT_OWNER_EMAIL'].iloc[0]

            # Construct the email content
            body = f"Hello {first_name},<br><br>Please help to comment/disposition the lots under your name with ECD:<br><br>"
            html_content = body + create_html_table(group)

            # Send the email
            send_email(to_email, '', subject, html_content)

        '''
        # Group by LOT_OWNER_EMAIL for specific LOT_STATE values
        stores_grouped = query_df[query_df['LOT_STATE'].isin(['StoresWaitingPE', 'StoresWaitingIntegration'])].groupby('LO_EMAIL')

        for email, group in stores_grouped:
            first_name = group['LO_NAME'].iloc[0]
            subject = "[P5051 Help Needed] Stores Lot Disposition"
            
            # Override the recipient email with the test email address for testing
            to_email = test_email #change to: email

            # Construct the email content
            body = f"Hello {first_name},<br><br>Please help to comment/disposition the lots under your name with ECD:<br><br>"
            html_content = body + create_html_table(group)

            # Send the email
            send_email(to_email, '', subject, html_content)  # No CC for stores lots 
        '''

    except Exception as e:
        logging.error(f"An error occurred: {e}")

# Run the email sending process
send_emails()
